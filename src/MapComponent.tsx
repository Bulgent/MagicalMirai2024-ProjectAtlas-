import React, { useState, useEffect, useCallback } from 'react';
import {
  MapContainer,
  GeoJSON,
  Circle,
  Tooltip,
  useMap,
  Marker,
} from 'react-leaflet';
import { StyleFunction, LeafletMouseEvent, LatLngExpression } from 'leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import './App.css';
// import PbfLayer from './PbfComponentSetting';
import { computePath } from './ComputePath'

// Âú∞Âõ≥„Éá„Éº„Çø„ÅÆÂ∞éÂÖ•
import roads from './map_data/roads.json'
import points from './map_data/points.json'
import areas from './map_data/areas.json'

// PbfÈñ¢ÈÄ£„Éá„Éº„Çø„ÅÆÂ∞éÂÖ•
import PbfLayer from './pbf/PbfComponentSetting';


interface PointProperties {
  name: string;
  coordinates: [number, number];
}

export const MapComponent = (props: any) => {
  const [clickedPoints, setClickedPoints] = useState<PointProperties[]>([]);
  const position: [number, number] = [34.6937, 135.5021];
  const [center, setCenter] = useState<[number, number]>(position);
  const [isMoving, setIsMoving] = useState(false);
  const [circlePosition, setCirclePosition] = useState<[number, number]>([
    34.3395651, 135.18270817
  ]);
  const [clickedCount, setClickedCount] = useState(0);
  const [pointPositions, setPointPositions] = useState<[number, number][]>([]);
  const [panels, setPanels] = useState<string[]>([]);
  const [songKashi, setKashi] = useState(props.kashi)



  // point„Éá„Éº„Çø„ÇíÂõ≥ÂΩ¢„Å®„Åó„Å¶Ë°®Áèæ
  const pointToLayer = (feature: any, latlng: LatLngExpression) => {
    const circleMarkerOptions = {
      radius: 6,
      fillColor: 'white',
      color: 'red',
      weight: 2,
      fillOpacity: 1,
    };
    return L.circleMarker(latlng, circleMarkerOptions);
  };

  // line, polygon„Éá„Éº„Çø„ÇíÂõ≥ÂΩ¢„Å®„Åó„Å¶Ë°®Áèæ
  const mapStyle: StyleFunction = (feature) => {
    switch (feature?.geometry?.type) {
      case 'MultiLineString':
        return {
          color: '#99abc2',
          weight: 10,
        };
      case 'MultiPolygon':
        return {
          fillColor: '#90dbee',
          weight: 2,
          opacity: 0.5,
          color: 'gray',
          fillOpacity: 1,
        };
      default:
        return {};
    }
  };

  // line, polygon„Éá„Éº„Çø„ÇíÂõ≥ÂΩ¢„Å®„Åó„Å¶Ë°®Áèæ
  const mapStylePathWay: StyleFunction = (feature) => {
    switch (feature?.geometry?.type) {
      case 'MultiLineString':
        return {
          color: 'blue',
          weight: 5,
          opacity:0.5,
        };
      default:
        return {};
    }
  };

  const PathWay: React.FC = () =>{
    const features = computePath()
        if (features){
      const geojson = {
        type:"FeatureCollection",
        features:features
      }
      return(
        <GeoJSON
              data={geojson as GeoJSON.GeoJsonObject}
              style={mapStylePathWay}/>
              )
    }else{
      return null
    }
  }

  // Ê©üËÉΩ„ÉÜ„Çπ„ÉàÁî®
  // isMoving„ÅÆÂÄ§„ÅåÂ§â„Çè„Å£„Åü„ÇâÂÆüË°å
  // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Åó„Å¶ÂÆüË°å„Åó„Å™„ÅÑ„Å®Âãï„Åã„Å™„ÅÑ?
  const MoveMap = () => {
    const map = useMap();
    useEffect(() => {
      // false„ÅÆÂ†¥ÂêàÂãï„Åã„Å™„ÅÑ
      if (!isMoving) {
        return;
      }
      // true„ÅÆÂ†¥Âêà
      // 50msÊØé„Å´Âπ≥Ë°åÁßªÂãï
      const timerId = setInterval(() => {
        setCenter((prevCenter) => [prevCenter[0], prevCenter[1] + 0.001]);
        map.setView(center, 16);
      }, 50);
      // false„ÅÆreturn„ÅÆË∑°„Å´interval„ÅÆÂÄ§„Çíclear„Å´„É™„Çª„ÉÉ„Éà
      return () => {
        clearInterval(timerId);
      };
    }, [isMoving]);
    // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Åó„Å¶„ÅÆÂà©Áî®„ÅÆ„Åü„ÇÅ„Å´
    return null;
  };

  // Ê≠åË©ûË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàüëΩ
  // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Åó„Å¶ÂÆüË°å„Åó„Å™„ÅÑ„Å®Âãï„Åã„Å™„ÅÑ?
  const MapKashi = () => {
    const map = useMap();
    // console.log(map.getSize(), map.getCenter(), map.getBounds())
    // var markertext = L.marker(map.getCenter(), { opacity: 1 });
    if(props.kashi!=""){
      var markertext = L.marker([Math.random() *
        (map.getBounds().getNorth() -
          map.getBounds().getSouth()) +
        map.getBounds().getSouth(),
        Math.random() *
        (map.getBounds().getEast() -
          map.getBounds().getWest()) +
        map.getBounds().getWest()], { opacity: 1 });
      markertext.bindTooltip(props.kashi, { permanent: true })
      markertext.addTo(map);
    }

    // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Åó„Å¶„ÅÆÂà©Áî®„ÅÆ„Åü„ÇÅ„Å´
    return null;
  };


  // Ê©üËÉΩ„ÉÜ„Çπ„ÉàÁî®
  // isMoving„ÇíÂàá„ÇäÊõø„Åà„ÇãÔºàÂú∞Âõ≥ÁßªÂãï„ÅÆÁô∫ÁÅ´ÁÇπÔºâ
  const handleMapMove = () => {
    setIsMoving((prevIsMoving) => !prevIsMoving);
  };

  // Ê©üËÉΩ„ÉÜ„Çπ„ÉàÁî®
  // ÊèèÁîª„Åô„Çãpoint„ÇíËøΩÂä†„Åô„Çã
  const addPoint = () => {
    const newPoint: [number, number] = [
      center[0] + Math.random() * 0.01,
      center[1] + Math.random() * 0.01,
    ];
    setPointPositions((prevPositions) => [...prevPositions, newPoint]);
  };

  // Ê©üËÉΩ„ÉÜ„Çπ„ÉàÁî®
  // „Ç´„Ç¶„É≥„Éà„ÇíÂ¢ó„ÇÑ„Åó„Å¶ÊèèÁîª„Åô„Çã‰ΩçÁΩÆ„ÇíÂ§âÊõ¥
  // useCallback„Çí‰Ωø„ÅÜÁêÜÁî±„ÅåÂàÜ„Åã„Çâ„Å™„ÅÑ
  const handleCircleClick = useCallback(() => {
    setClickedCount((count) => count + 1);
    setCirclePosition([
      center[0] + Math.random() * 0.01,
      center[1] + Math.random() * 0.01,
    ]);
  }, []);

  // Ê©üËÉΩ„ÉÜ„Çπ„ÉàÁî®
  // ÊèèÁîª„Åô„ÇãÊñáÂ≠ó„ÇíËøΩÂä†„Åô„Çã
  const addSomePanels = (index: number, key: string) => {
    const newPanel: string = `clicked ${key}`;
    setPanels((prevPanels) => [...prevPanels, newPanel]);
    setPointPositions((prevPositions) =>
      prevPositions.filter((_, i) => i !== index)
    );
  };

  // ?„Å®:„ÅßifÊñá„ÇíÊõ∏„ÅÑ„Å¶„ÅÑ„Çã:„Ååelse 
  const clickedText =
    clickedCount === 0
      ? 'Click this Circle to change the Tooltip text'
      : `Circle click: ${clickedCount}`;

  const onPointClick = (e: LeafletMouseEvent) => {
    const clickedPointProperties: PointProperties = {
      name: e.sourceTarget.feature.properties.name,
      coordinates: e.sourceTarget.feature.geometry.coordinates
    };
    // properties.name„Å®geometry.coordinates„ÅÆÂÄ§„ÇíÈÄ£ÊÉ≥ÈÖçÂàó„Å®„Åó„Å¶Ê†ºÁ¥ç
    setClickedPoints(prevPoints => [...prevPoints, clickedPointProperties]);
  };

  return (
    <>

      {/* center„ÅØ[Á∑ØÂ∫¶, ÁµåÂ∫¶] */}
      {/* zoom„ÅØ16„Åè„Çâ„ÅÑ„Åågood */}

      <MapContainer className='mapcomponent' center={center} zoom={16} style={{ backgroundColor: '#f5f3f3' }} dragging={true} attributionControl={false}>
        <GeoJSON
          data={areas as GeoJSON.GeoJsonObject}
          style={mapStyle}
        />
        <GeoJSON
          data={roads as GeoJSON.GeoJsonObject}
          style={mapStyle}
        />
        <GeoJSON
          data={points as GeoJSON.GeoJsonObject}
          pointToLayer={pointToLayer}
          onEachFeature={(_, layer) => {
            layer.on({
              click: onPointClick // „Éù„Ç§„É≥„Éà„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Å®„Åç„Å´Âëº„Å≥Âá∫„Åï„Çå„ÇãÈñ¢Êï∞
            });
          }}
        />

        <PathWay />
         {/* <PbfLayer
          url="https://cyberjapandata.gsi.go.jp/xyz/experimental_bvmap/{z}/{x}/{y}.pbf"
          maxNativeZoom={16} // Ëß£ÂÉèÂ∫¶„ÇíË™øÊï¥ÔºàÂÄ§„ÅåÂ∞è„Åï„ÅÑÁ®ã„Éá„Éº„ÇøÈáè„ÅåÂ∞è„Åï„ÅÑÔºâ
          minNativeZoom={16}
          vectorTileLayerStyles={
            {
              "lake": {
                color: "#90dbee",
                opacity: 1,
                weight: 0.5,
                fill: true,
                fillColor: "#90dbee",
                fillOpacity: 1,
              },
              "waterarea": {
                color: "#90dbee",
                opacity: 1,
                weight: 0.5,
                fill: true,
                fillColor: "#90dbee",
                fillOpacity: 1,
              },
              "river": {
                color: "#90dbee",
                opacity: 1,
                weight: 0.5
              },
              "building": {
                color: "#9d9da0",
                opacity: 1,
                weight: 0.5,
                fill: true,
                fillColor: "#e8e9ed",
                fillOpacity: 1,
              },
              "road": {
                color: "#b5c5d3",
                opacity: 0,
                weight: 0.5,
              },

              // „Åì„Åì„Åã„Çâ‰∏ã„ÅØÂ§öÂàÜ„ÅÑ„Çâ„Å™„ÅÑÔºàË¶ã„Åà„Å™„ÅÑ„Çà„ÅÜ„Å´opacity:0Ôºâ
              "coastline": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "wstructurea": {
                color: "red",
                opacity: 1,
                weight: 0.5,
                fill: true,
                fillColor: "#red",
                fillOpacity: 1,
              },
              "structurel": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "landforma": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "transp": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "label": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "elevation": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "contour": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "landforml": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "boundary": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "searoute": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "symbol": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "structurea": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "landformp": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
              "railway": {
                color: "red",
                opacity: 0,
                weight: 0.5
              },
            }
          }
        /> */}

        <Circle
          center={circlePosition}
          eventHandlers={{
            click: handleCircleClick,
          }}
          pathOptions={{ fillColor: 'blue' }}
          radius={6}
        >
          <Tooltip>{clickedText}</Tooltip>
        </Circle>
        {
          pointPositions.map((position) => (
            <Marker
              key={`${position[0]}-${position[1]}`}
              position={position}
              eventHandlers={{
                click: () => addSomePanels(pointPositions.indexOf(position), `${position[0]}-${position[1]}`),
              }}
            />
          ))
        }
        <MoveMap />
        <MapKashi />
      </MapContainer>


      {/* Âá∫ÂäõÁ¢∫Ë™çÁî®„ÄÅÂ†¥ÊâÄ„ÇíÁßªÂãï„Åï„Åõ„Çã‚Üì */}
      {/* „Åì„Çå„Åå„ÅÇ„Çã„Å®„Éû„ÉÉ„Éó„ÅÆË°®Á§∫„Åå‰∏ã„Å´„Åö„Çå„Çã */}
      {/* <ul>
          {clickedPoints.map((point, index) => (
            <li key={index}>
              Name: {point.name}, Coordinates: {point.coordinates}
            </li>
          ))}
        </ul> */}
      {/* Âá∫ÂäõÁ¢∫Ë™çÁî®„ÄÅÂ†¥ÊâÄ„ÇíÁßªÂãï„Åï„Åõ„Çã‚Üë */}

      {
        panels.map((label) => (
          <p>{label}</p>
        ))
      }
      <button onClick={handleMapMove}>
        {isMoving ? 'ÂÅúÊ≠¢' : 'Âú∞Âõ≥„ÇíÁßªÂãï'}
      </button>
      <button onClick={addPoint}>
        Add Point
      </button>
    </>
  );
};
